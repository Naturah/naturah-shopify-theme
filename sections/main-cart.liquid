{% comment %}
  @file Main Cart Section
  @summary Primary cart page section for displaying cart items and checkout
  @implements Theme editor settings for cart display options
{% endcomment %}

<div class="section section-cart py-12 md:py-16">
  <div class="container mx-auto px-4">
    <h1 class="text-2xl md:text-3xl font-bold mb-8 text-neutral-dark">{{ 'cart.general.title' | t }}</h1>
    
    {% if cart.item_count > 0 %}
      <form action="{{ routes.cart_url }}" method="post" id="cart-form" class="cart-form">
        <div class="cart-inner grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="cart-items lg:col-span-2 bg-white rounded-xl shadow-sm p-6">
            <div class="cart-header hidden md:grid md:grid-cols-12 gap-4 pb-4 mb-6 border-b border-neutral-light text-sm font-medium text-neutral-medium">
              <div class="md:col-span-6">{{ 'cart.label.product' | t }}</div>
              <div class="md:col-span-2 text-center">{{ 'cart.label.price' | t }}</div>
              <div class="md:col-span-2 text-center">{{ 'cart.label.quantity' | t }}</div>
              <div class="md:col-span-2 text-right">{{ 'cart.label.total' | t }}</div>
            </div>
            
            <div class="cart-items-list space-y-6">
              {% for item in cart.items %}
                <div class="cart-item grid grid-cols-1 md:grid-cols-12 gap-4 items-center pb-6 {% unless forloop.last %}border-b border-neutral-light{% endunless %}">
                  <div class="cart-item-info col-span-1 md:col-span-6 flex items-center">
                    <div class="cart-item-image w-24 h-24 flex-shrink-0 mr-4 rounded-lg overflow-hidden border border-neutral-light">
                      {% if item.image %}
                        <img
                          src="{{ item.image | image_url: width: 120 }}"
                          alt="{{ item.title | escape }}"
                          loading="lazy"
                          width="120"
                          height="120"
                          class="w-full h-full object-cover"
                        >
                      {% else %}
                        <div class="w-full h-full bg-brand-light/30 flex items-center justify-center">
                          {% render 'icon-leaf', class: 'w-8 h-8 text-brand-medium/50' %}
                        </div>
                      {% endif %}
                    </div>
                    <div class="cart-item-details flex-1">
                      <h3 class="cart-item-title text-neutral-dark font-medium">
                        <a href="{{ item.url }}" class="hover:text-brand-dark transition-colors">{{ item.product.title }}</a>
                      </h3>
                      
                      {% unless item.product.has_only_default_variant %}
                        <p class="text-sm text-neutral-medium">
                          {% for option in item.options_with_values %}
                            {{ option.name }}: {{ option.value }}{% unless forloop.last %}, {% endunless %}
                          {% endfor %}
                        </p>
                      {% endunless %}
                      
                      {% if item.selling_plan_allocation %}
                        <p class="text-sm text-brand-dark">
                          {{ item.selling_plan_allocation.selling_plan.name }}
                        </p>
                      {% endif %}
                      
                      <div class="cart-item-remove flex mt-2 md:hidden">
                        <button type="button" class="cart-remove-btn text-sm text-neutral-medium hover:text-brand-dark transition-colors flex items-center" 
                          data-item-key="{{ item.key }}">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-4 h-4 mr-1">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
                          </svg>
                          {{ 'cart.general.remove' | t }}
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <div class="cart-item-price md:col-span-2 text-neutral-dark md:text-center">
                    <span class="text-sm md:hidden">{{ 'cart.label.price' | t }}:</span>
                    <span class="font-medium">{{ item.original_price | money }}</span>
                    
                    {% if item.original_price != item.final_price %}
                      <span class="block text-sm text-brand-dark">{{ item.final_price | money }}</span>
                      <span class="block text-xs text-neutral-medium">{{ item.discounts | join: ', ' }}</span>
                    {% endif %}
                  </div>
                  
                  <div class="cart-item-quantity md:col-span-2 md:text-center">
                    <span class="text-sm md:hidden">{{ 'cart.label.quantity' | t }}:</span>
                    <div class="quantity-input flex w-24 md:mx-auto border border-brand-light rounded-full overflow-hidden shadow-sm">
                      <button type="button" class="quantity-down w-7 h-8 flex items-center justify-center text-neutral-dark border-r border-brand-light hover:bg-brand-light/30 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15" />
                        </svg>
                      </button>
                      <input 
                        type="number" 
                        name="updates[]" 
                        value="{{ item.quantity }}" 
                        min="0" 
                        aria-label="{{ 'cart.label.quantity' | t }}" 
                        class="quantity-field flex-1 w-10 text-center border-none focus:ring-0 p-0 bg-white"
                        data-item-key="{{ item.key }}"
                      >
                      <button type="button" class="quantity-up w-7 h-8 flex items-center justify-center text-neutral-dark border-l border-brand-light hover:bg-brand-light/30 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  
                  <div class="cart-item-total md:col-span-2 font-medium text-neutral-dark md:text-right flex justify-between md:block">
                    <span class="text-sm md:hidden">{{ 'cart.label.total' | t }}:</span>
                    <span>{{ item.final_line_price | money }}</span>
                    
                    <button type="button" class="cart-remove-btn hidden md:inline-flex text-neutral-medium hover:text-brand-dark transition-colors" 
                      data-item-key="{{ item.key }}">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                </div>
              {% endfor %}
            </div>
            
            <div class="cart-footer flex justify-between items-center mt-8 pt-6 border-t border-neutral-light">
              <div class="cart-update">
                <button type="submit" class="update-cart-button px-4 py-2 text-sm text-neutral-dark border border-neutral-light rounded-full hover:border-brand-light hover:bg-brand-light/20 transition-colors">
                  {{ 'cart.general.update' | t }}
                </button>
              </div>
              
              <div class="cart-continue-shopping">
                <a href="{{ routes.collections_url }}" class="text-sm text-neutral-dark hover:text-brand-dark transition-colors flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-4 h-4 mr-1">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                  </svg>
                  {{ 'cart.general.continue_shopping' | t }}
                </a>
              </div>
            </div>
          </div>
          
          <div class="cart-sidebar">
            <div class="cart-summary bg-white rounded-xl shadow-sm p-6">
              <h2 class="text-lg font-medium text-neutral-dark mb-6 pb-4 border-b border-neutral-light">{{ 'cart.general.summary' | t }}</h2>
              
              {% if cart.cart_level_discount_applications.size > 0 %}
                <div class="cart-discounts mb-4">
                  <h3 class="text-sm font-medium text-neutral-dark mb-2">{{ 'cart.general.discounts' | t }}</h3>
                  <ul class="space-y-1 text-sm">
                    {% for discount_application in cart.cart_level_discount_applications %}
                      <li class="flex justify-between items-center">
                        <span class="text-brand-dark">{{ discount_application.title }}</span>
                        <span>-{{ discount_application.total_allocated_amount | money }}</span>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
              
              <div class="cart-subtotal flex justify-between items-center mb-4">
                <span class="text-neutral-dark">{{ 'cart.general.subtotal' | t }}</span>
                <span class="font-medium text-neutral-dark">{{ cart.original_total_price | money }}</span>
              </div>
              
              <div class="cart-note mb-6">
                <label for="CartNote" class="block text-sm font-medium mb-2 text-neutral-dark">
                  {{ 'cart.general.note' | t }}
                </label>
                <textarea
                  name="note"
                  id="CartNote"
                  rows="3"
                  class="w-full border border-neutral-light rounded-lg p-2 text-sm bg-white focus:ring-1 focus:ring-brand-light focus:border-brand-light"
                  placeholder="{{ 'cart.general.note_placeholder' | t }}"
                >{{ cart.note }}</textarea>
              </div>
              
              <div class="cart-shipping-text text-sm text-neutral-medium mb-6">
                {{ 'cart.general.shipping_at_checkout' | t }}
              </div>
              
              <div class="checkout-button-wrapper">
                <button type="submit" name="checkout" class="checkout-button w-full bg-brand-medium text-neutral-dark font-medium py-3 px-6 rounded-full hover:bg-brand-dark hover:text-white transition-colors flex items-center justify-center shadow-sm">
                  <span>{{ 'cart.general.checkout' | t }}</span>
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 ml-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                  </svg>
                </button>
              </div>
              
              {% if additional_checkout_buttons %}
                <div class="additional-checkout-buttons mt-4">
                  {{ content_for_additional_checkout_buttons }}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </form>
    {% else %}
      <div class="empty-cart text-center py-12">
        <div class="empty-cart-icon mx-auto w-20 h-20 mb-6 text-brand-light">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
        </div>
        <h2 class="text-xl font-bold text-neutral-dark mb-4">{{ 'cart.general.empty' | t }}</h2>
        <p class="text-neutral-medium max-w-md mx-auto mb-8">{{ 'cart.general.empty_message' | t }}</p>
        <div class="empty-cart-action">
          <a href="{{ routes.collections_url }}" class="inline-block bg-brand-medium text-neutral-dark font-medium py-3 px-6 rounded-full hover:bg-brand-dark hover:text-white transition-colors shadow-sm">
            {{ 'cart.general.continue_shopping' | t }}
          </a>
        </div>
      </div>
    {% endif %}
  </div>
</div>

{% schema %}
{
  "name": "Cart Page",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_cart_note",
      "label": "Show cart note",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_cart_shipping_calculator",
      "label": "Enable shipping calculator",
      "default": false
    }
  ]
}
{% endschema %}

{% javascript %}
document.addEventListener('DOMContentLoaded', function() {
  // Quantity selectors
  const quantityDownBtns = document.querySelectorAll('.quantity-down');
  const quantityUpBtns = document.querySelectorAll('.quantity-up');
  const quantityFields = document.querySelectorAll('.quantity-field');
  const updateCartBtn = document.querySelector('.update-cart-button');
  const cartForm = document.getElementById('cart-form');
  const cartRemoveBtns = document.querySelectorAll('.cart-remove-btn');
  
  // Handle quantity down buttons
  quantityDownBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const input = this.closest('.quantity-input').querySelector('input');
      const currentValue = parseInt(input.value);
      if (currentValue > 0) {
        input.value = currentValue - 1;
      }
      highlightUpdateButton();
    });
  });
  
  // Handle quantity up buttons
  quantityUpBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const input = this.closest('.quantity-input').querySelector('input');
      const currentValue = parseInt(input.value);
      input.value = currentValue + 1;
      highlightUpdateButton();
    });
  });
  
  // Handle manual quantity changes
  quantityFields.forEach(field => {
    field.addEventListener('change', function() {
      highlightUpdateButton();
    });
  });
  
  // Handle item removal
  cartRemoveBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const itemKey = this.getAttribute('data-item-key');
      const quantityInput = document.querySelector(`.quantity-field[data-item-key="${itemKey}"]`);
      if (quantityInput) {
        quantityInput.value = 0;
        cartForm.submit();
      }
    });
  });
  
  function highlightUpdateButton() {
    updateCartBtn.classList.add('bg-brand-light/30');
    updateCartBtn.classList.add('border-brand-light');
  }
});
{% endjavascript %} 