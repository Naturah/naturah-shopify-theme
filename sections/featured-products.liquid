{% comment %}
  @file Featured Products Section
  @summary A customizable section to showcase featured or best-selling products
  @customizable
{% endcomment %}

<section class="featured-products py-12 md:py-16 lg:py-20 {% if section.settings.background_color == 'light' %}bg-naturah-cream{% elsif section.settings.background_color == 'dark' %}bg-naturah-dark{% elsif section.settings.background_color == 'accent' %}bg-naturah-green/10{% else %}bg-white{% endif %}" id="FeaturedProducts-{{ section.id }}">
  <div class="container mx-auto px-4">
    {% if section.settings.title != blank %}
      <div class="text-center mb-10">
        <h2 class="text-3xl md:text-4xl font-bold mb-3">{{ section.settings.title }}</h2>
        {% if section.settings.subtitle != blank %}
          <p class="text-lg text-naturah-black/80 max-w-3xl mx-auto">{{ section.settings.subtitle }}</p>
        {% endif %}
      </div>
    {% endif %}

    <div class="featured-products-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-{{ section.settings.products_per_row }} gap-6 md:gap-8">
      {%- for product in collections[section.settings.collection].products limit: section.settings.products_to_show -%}
        <div class="featured-product relative group transition-all duration-300 h-full">
          <div class="product-card rounded-lg overflow-hidden bg-white shadow-sm hover:shadow-md transition-shadow h-full flex flex-col">
            <div class="product-image-container relative pb-[100%] overflow-hidden bg-naturah-cream/50">
              {% if product.featured_media %}
                <a href="{{ product.url }}">
                  <img
                    srcset="
                      {%- if product.featured_media.preview_image.width >= 165 -%}{{ product.featured_media.preview_image | image_url: width: 165 }} 165w,{%- endif -%}
                      {%- if product.featured_media.preview_image.width >= 360 -%}{{ product.featured_media.preview_image | image_url: width: 360 }} 360w,{%- endif -%}
                      {%- if product.featured_media.preview_image.width >= 535 -%}{{ product.featured_media.preview_image | image_url: width: 535 }} 535w,{%- endif -%}
                      {%- if product.featured_media.preview_image.width >= 720 -%}{{ product.featured_media.preview_image | image_url: width: 720 }} 720w,{%- endif -%}
                      {{ product.featured_media.preview_image | image_url }} {{ product.featured_media.preview_image.width }}w
                    "
                    src="{{ product.featured_media.preview_image | image_url: width: 535 }}"
                    sizes="(min-width: 1200px) calc((1200px - 10rem) / {{ section.settings.products_per_row }}), (min-width: 750px) calc((100vw - 11.5rem) / 2), calc(100vw - 4rem)"
                    loading="lazy"
                    width="{{ product.featured_media.preview_image.width }}"
                    height="{{ product.featured_media.preview_image.height }}"
                    alt="{{ product.featured_media.alt | escape }}"
                    class="absolute inset-0 w-full h-full object-cover object-center group-hover:scale-105 transition-transform duration-300"
                  >
                </a>
              {% else %}
                <div class="absolute inset-0 bg-naturah-cream/30 flex items-center justify-center">
                  {% render 'icon-leaf', class: 'w-16 h-16 text-naturah-green/40' %}
                </div>
              {% endif %}

              {% if section.settings.show_secondary_image and product.media[1] %}
                <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  <a href="{{ product.url }}">
                    <img
                      srcset="
                        {%- if product.media[1].preview_image.width >= 165 -%}{{ product.media[1].preview_image | image_url: width: 165 }} 165w,{%- endif -%}
                        {%- if product.media[1].preview_image.width >= 360 -%}{{ product.media[1].preview_image | image_url: width: 360 }} 360w,{%- endif -%}
                        {%- if product.media[1].preview_image.width >= 535 -%}{{ product.media[1].preview_image | image_url: width: 535 }} 535w,{%- endif -%}
                        {%- if product.media[1].preview_image.width >= 720 -%}{{ product.media[1].preview_image | image_url: width: 720 }} 720w,{%- endif -%}
                        {{ product.media[1].preview_image | image_url }} {{ product.media[1].preview_image.width }}w
                      "
                      src="{{ product.media[1].preview_image | image_url: width: 535 }}"
                      sizes="(min-width: 1200px) calc((1200px - 10rem) / {{ section.settings.products_per_row }}), (min-width: 750px) calc((100vw - 11.5rem) / 2), calc(100vw - 4rem)"
                      loading="lazy"
                      width="{{ product.media[1].preview_image.width }}"
                      height="{{ product.media[1].preview_image.height }}"
                      alt="{{ product.media[1].alt | escape }}"
                      class="absolute inset-0 w-full h-full object-cover object-center"
                    >
                  </a>
                </div>
              {% endif %}

              {% if section.settings.show_badges %}
                <div class="product-badges absolute top-2 left-2 flex flex-col gap-2">
                  {% if product.available == false %}
                    <span class="badge sold-out-badge text-xs font-medium py-1 px-2 bg-naturah-black text-white rounded">{{ 'products.product.sold_out' | t }}</span>
                  {% endif %}
                  
                  {% if product.compare_at_price > product.price and product.available %}
                    <span class="badge sale-badge text-xs font-medium py-1 px-2 bg-naturah-red text-white rounded">
                      {{ 'products.product.on_sale' | t }}
                    </span>
                  {% endif %}
                  
                  {% if product.tags contains 'New' %}
                    <span class="badge new-badge text-xs font-medium py-1 px-2 bg-naturah-green text-white rounded">{{ 'products.product.new' | t }}</span>
                  {% endif %}
                </div>
              {% endif %}

              {% if section.settings.show_quick_add %}
                <div class="absolute inset-x-0 bottom-4 flex justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  {% if product.available and product.has_only_default_variant %}
                    <product-form>
                      {%- form 'product', product, id: 'QuickAddForm-' | append: section.id | append: '-' | append: product.id, class: 'quick-add-form' -%}
                        <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                        <button type="submit" name="add" class="quick-add-button px-4 py-2 text-sm font-medium text-white bg-naturah-green hover:bg-naturah-green-dark rounded-full transition-colors duration-200 flex items-center">
                          <span class="icon mr-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                          </span>
                          <span>{{ 'products.product.add_to_cart' | t }}</span>
                        </button>
                      {%- endform -%}
                    </product-form>
                  {% else %}
                    <a href="{{ product.url }}" class="quick-view-button px-4 py-2 text-sm font-medium text-white bg-naturah-green hover:bg-naturah-green-dark rounded-full transition-colors duration-200 flex items-center">
                      <span class="icon mr-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                        </svg>
                      </span>
                      <span>{{ 'products.product.view_details' | t }}</span>
                    </a>
                  {% endif %}
                </div>
              {% endif %}
            </div>

            <div class="product-info p-4 flex flex-col flex-grow">
              {% if section.settings.show_vendor and product.vendor %}
                <div class="product-vendor text-xs text-naturah-black/60 mb-1">
                  {{ product.vendor }}
                </div>
              {% endif %}
              
              <h3 class="product-title text-naturah-black font-medium mb-1">
                <a href="{{ product.url }}" class="hover:text-naturah-green transition-colors duration-200">
                  {{ product.title }}
                </a>
              </h3>

              <div class="product-price {% if product.compare_at_price > product.price %}sale{% endif %} mb-2">
                <span class="price {% if product.compare_at_price > product.price %}text-naturah-red{% endif %}">
                  {{ product.price | money }}
                </span>
                {% if product.compare_at_price > product.price %}
                  <span class="compare-at-price text-naturah-black/60 text-sm line-through ml-2">
                    {{ product.compare_at_price | money }}
                  </span>
                {% endif %}
              </div>

              {% if section.settings.show_rating and product.metafields.reviews.rating %}
                <div class="product-rating flex items-center mb-3">
                  <span class="stars relative inline-block w-20 h-4 text-naturah-black/20">
                    <svg class="absolute inset-0" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 105 20">
                      <path d="M10.5 0l3.5 7 7 1-5 4.5 1 7-6.5-3.5L4 19.5l1-7L0 8l7-1 3.5-7zM31.5 0l3.5 7 7 1-5 4.5 1 7-6.5-3.5L25 19.5l1-7-5-4.5 7-1 3.5-7zM52.5 0l3.5 7 7 1-5 4.5 1 7-6.5-3.5L46 19.5l1-7-5-4.5 7-1 3.5-7zM73.5 0l3.5 7 7 1-5 4.5 1 7-6.5-3.5L67 19.5l1-7-5-4.5 7-1 3.5-7zM94.5 0l3.5 7 7 1-5 4.5 1 7-6.5-3.5L88 19.5l1-7-5-4.5 7-1 3.5-7z"/>
                    </svg>
                    <span class="stars-filled absolute inset-0 overflow-hidden text-naturah-yellow" style="width: {{ product.metafields.reviews.rating.value | times: 20 }}%">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 105 20">
                        <path d="M10.5 0l3.5 7 7 1-5 4.5 1 7-6.5-3.5L4 19.5l1-7L0 8l7-1 3.5-7zM31.5 0l3.5 7 7 1-5 4.5 1 7-6.5-3.5L25 19.5l1-7-5-4.5 7-1 3.5-7zM52.5 0l3.5 7 7 1-5 4.5 1 7-6.5-3.5L46 19.5l1-7-5-4.5 7-1 3.5-7zM73.5 0l3.5 7 7 1-5 4.5 1 7-6.5-3.5L67 19.5l1-7-5-4.5 7-1 3.5-7zM94.5 0l3.5 7 7 1-5 4.5 1 7-6.5-3.5L88 19.5l1-7-5-4.5 7-1 3.5-7z"/>
                      </svg>
                    </span>
                  </span>
                  <span class="rating-count text-xs text-naturah-black/60 ml-1">
                    ({{ product.metafields.reviews.rating_count }})
                  </span>
                </div>
              {% endif %}

              {% if section.settings.show_description and product.description != blank %}
                <div class="product-description text-sm text-naturah-black/70 line-clamp-2 mb-4">
                  {{ product.description | strip_html | truncatewords: 15 }}
                </div>
              {% endif %}

              <div class="mt-auto">
                {% if section.settings.show_color_swatches and product.has_only_default_variant == false %}
                  {% assign option_index = 0 %}
                  {% for option in product.options_with_values %}
                    {% if option.name == 'Color' or option.name == 'Colour' %}
                      <div class="product-color-swatches flex flex-wrap gap-1 mt-2">
                        {% for value in option.values %}
                          {% assign color_swatch_handle = value | handle %}
                          <a href="{{ product.url }}?variant={{ product.variants[forloop.index0].id }}" 
                            class="color-swatch w-6 h-6 rounded-full border border-naturah-black/10 overflow-hidden"
                            title="{{ value }}"
                            style="background-color: {{ color_swatch_handle | replace: '-', ' ' | replace: 'custom', '' }};">
                          </a>
                        {% endfor %}
                      </div>
                      {% break %}
                    {% endif %}
                    {% assign option_index = option_index | plus: 1 %}
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {%- else -%}
        {%- for i in (1..section.settings.products_to_show) -%}
          <div class="featured-product-placeholder">
            <div class="product-card rounded-lg overflow-hidden bg-white shadow-sm h-full flex flex-col animate-pulse">
              <div class="product-image-container relative pb-[100%] bg-naturah-cream/30"></div>
              <div class="product-info p-4 flex flex-col">
                <div class="h-4 bg-naturah-cream/50 rounded w-1/3 mb-2"></div>
                <div class="h-5 bg-naturah-cream/50 rounded w-2/3 mb-3"></div>
                <div class="h-4 bg-naturah-cream/50 rounded w-1/4 mb-4"></div>
                <div class="h-3 bg-naturah-cream/50 rounded w-full mb-2"></div>
                <div class="h-3 bg-naturah-cream/50 rounded w-5/6"></div>
              </div>
            </div>
          </div>
        {%- endfor -%}
      {%- endfor -%}
    </div>

    {% if section.settings.show_view_all and collections[section.settings.collection].all_products_count > section.settings.products_to_show %}
      <div class="view-all-container text-center mt-10">
        <a href="{{ collections[section.settings.collection].url }}" class="view-all-button inline-block px-6 py-3 rounded-md font-medium text-base transition-colors duration-200 {% if section.settings.button_style == 'primary' %}bg-naturah-green text-white hover:bg-naturah-green-dark{% elsif section.settings.button_style == 'secondary' %}bg-naturah-cream text-naturah-black hover:bg-naturah-cream/80{% elsif section.settings.button_style == 'outline' %}bg-transparent border-2 border-naturah-green text-naturah-green hover:bg-naturah-green/5{% endif %}">
          {{ section.settings.view_all_text }}
        </a>
      </div>
    {% endif %}
  </div>
</section>

{% schema %}
{
  "name": "Featured Products",
  "tag": "section",
  "class": "section-featured-products",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "default": "Featured Products",
      "label": "Heading"
    },
    {
      "type": "text",
      "id": "subtitle",
      "default": "Shop our most popular products",
      "label": "Subheading"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "select",
      "id": "background_color",
      "options": [
        {
          "value": "none",
          "label": "None"
        },
        {
          "value": "light",
          "label": "Light"
        },
        {
          "value": "dark",
          "label": "Dark"
        },
        {
          "value": "accent",
          "label": "Accent"
        }
      ],
      "default": "none",
      "label": "Background color"
    },
    {
      "type": "range",
      "id": "products_per_row",
      "min": 2,
      "max": 4,
      "step": 1,
      "default": 4,
      "label": "Products per row"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 4,
      "label": "Maximum products to show"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": true,
      "label": "Show vendor"
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "default": true,
      "label": "Show description"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "default": true,
      "label": "Show product rating"
    },
    {
      "type": "checkbox",
      "id": "show_badges",
      "default": true,
      "label": "Show product badges"
    },
    {
      "type": "checkbox",
      "id": "show_secondary_image",
      "default": true,
      "label": "Show second image on hover"
    },
    {
      "type": "checkbox",
      "id": "show_color_swatches",
      "default": true,
      "label": "Show color swatches"
    },
    {
      "type": "checkbox",
      "id": "show_quick_add",
      "default": true,
      "label": "Show quick add button"
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "default": true,
      "label": "Show 'View all' button"
    },
    {
      "type": "text",
      "id": "view_all_text",
      "default": "View All Products",
      "label": "'View all' button text"
    },
    {
      "type": "select",
      "id": "button_style",
      "options": [
        {
          "value": "primary",
          "label": "Primary"
        },
        {
          "value": "secondary",
          "label": "Secondary"
        },
        {
          "value": "outline",
          "label": "Outline"
        }
      ],
      "default": "primary",
      "label": "Button style"
    }
  ],
  "presets": [
    {
      "name": "Featured Products",
      "settings": {
        "collection": "",
        "products_per_row": 4,
        "products_to_show": 4
      }
    }
  ]
}
{% endschema %}

{% stylesheet %}
.featured-product:hover .quick-add-button,
.featured-product:hover .quick-view-button {
  transform: translateY(0);
  opacity: 1;
}

.quick-add-button,
.quick-view-button {
  transform: translateY(10px);
  opacity: 0;
  transition: all 0.3s ease;
}
{% endstylesheet %}

{% javascript %}
class ProductForm extends HTMLElement {
  constructor() {
    super();
    this.form = this.querySelector('form');
    this.form.addEventListener('submit', this.onSubmit.bind(this));
  }

  onSubmit(evt) {
    evt.preventDefault();
    const submitButton = this.querySelector('[type="submit"]');
    const originalText = submitButton.innerHTML;

    submitButton.classList.add('loading');
    submitButton.innerHTML = 'Adding...';

    const config = {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Accept': 'application/json'
      },
      body: new URLSearchParams(new FormData(this.form))
    };

    fetch('/cart/add.js', config)
      .then(response => response.json())
      .then(data => {
        submitButton.innerHTML = 'Added!';
        
        setTimeout(() => {
          submitButton.innerHTML = originalText;
          submitButton.classList.remove('loading');
        }, 2000);
        
        // Trigger cart update
        const cartUpdateEvent = new CustomEvent('cart:refresh');
        document.documentElement.dispatchEvent(cartUpdateEvent);
      })
      .catch(error => {
        console.error('Error:', error);
        submitButton.innerHTML = 'Error!';
        
        setTimeout(() => {
          submitButton.innerHTML = originalText;
          submitButton.classList.remove('loading');
        }, 2000);
      });
  }
}

customElements.define('product-form', ProductForm);
{% endjavascript %}