{% comment %}
  @file Featured Products Section
  @summary A simple section to showcase featured products
{% endcomment %}

<section class="section-featured-products py-12 {% if section.settings.background_color == 'light' %}bg-background{% elsif section.settings.background_color == 'dark' %}bg-neutral-dark{% else %}bg-white{% endif %}">
  <div class="container mx-auto px-4">
    {% if section.settings.title != blank %}
      <div class="text-center mb-10">
        <h2 class="text-3xl font-bold mb-3">{{ section.settings.title }}</h2>
        {% if section.settings.subtitle != blank %}
          <p class="text-lg text-neutral-medium max-w-3xl mx-auto">{{ section.settings.subtitle }}</p>
        {% endif %}
      </div>
    {% endif %}

    {% assign products_per_row = section.settings.products_per_row | default: 4 %}
    {% assign products_to_show = section.settings.products_to_show | default: 4 %}
    {% assign collection = collections[section.settings.collection] %}
    
    <div class="featured-products-grid gap-6">
      {%- if collection != blank -%}
        {%- for product in collection.products limit: products_to_show -%}
          <div class="product-card bg-white rounded-lg overflow-hidden shadow-sm h-full flex flex-col">
            <div class="relative pb-[100%] bg-brand-light/30">
              {% if product.featured_image != blank %}
                <a href="{{ product.url }}">
                  <img
                    src="{{ product.featured_image | image_url: width: 500, height: 500, crop: 'center' }}"
                    alt="{{ product.featured_image.alt | escape }}"
                    class="absolute inset-0 w-full h-full object-cover"
                    loading="lazy"
                    width="500"
                    height="500"
                  >
                </a>
              {% endif %}
              
              {% if product.available == false %}
                <span class="absolute top-2 left-2 text-xs font-medium py-1 px-2 bg-neutral-dark text-white rounded">
                  Sold Out
                </span>
              {% elsif product.compare_at_price > product.price %}
                <span class="absolute top-2 left-2 text-xs font-medium py-1 px-2 bg-brand-dark text-white rounded">
                  Sale
                </span>
              {% endif %}
            </div>

            <div class="p-4 flex flex-col flex-grow">
              <h3 class="font-medium mb-1">
                <a href="{{ product.url }}" class="text-neutral-dark hover:text-brand-dark no-underline">
                  {{ product.title }}
                </a>
              </h3>

              <div class="flex justify-between items-center mb-2">
                <div>
                  <span class="{% if product.compare_at_price > product.price %}text-brand-dark{% endif %}">
                    {{ product.price | money }}
                  </span>
                  {% if product.compare_at_price > product.price %}
                    <span class="text-neutral-medium text-sm line-through ml-2">
                      {{ product.compare_at_price | money }}
                    </span>
                  {% endif %}
                </div>
                
                {% if product.metafields.reviews.rating %}
                  <div class="flex items-center">
                    <div class="relative w-16 h-3">
                      <div class="absolute inset-0 text-neutral-light">★★★★★</div>
                      <div class="absolute inset-0 text-brand-dark overflow-hidden" style="width: {{ product.metafields.reviews.rating.value | times: 20 }}%;">★★★★★</div>
                    </div>
                    <span class="text-xs text-neutral-medium ml-1">({{ product.metafields.reviews.rating_count }})</span>
                  </div>
                {% endif %}
              </div>

              {% if section.settings.show_description and product.description != blank %}
                <div class="text-sm text-neutral-medium mb-4 overflow-hidden text-ellipsis line-clamp-2">
                  {{ product.description | strip_html | truncatewords: 15 }}
                </div>
              {% endif %}

              {% if section.settings.show_quick_add and product.available %}
                <div class="mt-auto">
                  <form method="post" action="/cart/add">
                    <input type="hidden" name="id" value="{{ product.variants.first.id }}">
                    <button type="submit" class="w-full py-2 px-4 text-sm font-medium text-neutral-dark bg-brand-medium hover:bg-brand-dark hover:text-white transition-colors rounded-full shadow-sm">
                      Add to Cart
                    </button>
                  </form>
                </div>
              {% endif %}
            </div>
          </div>
        {%- endfor -%}
      {%- else -%}
        {%- for i in (1..4) -%}
          <div class="bg-white rounded-lg overflow-hidden shadow-sm h-full flex flex-col">
            <div class="relative pb-[100%] bg-brand-light/30"></div>
            <div class="p-4 flex flex-col">
              <div class="h-4 bg-brand-light rounded w-1/3 mb-2"></div>
              <div class="h-5 bg-brand-light rounded w-2/3 mb-3"></div>
              <div class="h-4 bg-brand-light rounded w-1/4 mb-4"></div>
              <div class="h-3 bg-brand-light rounded w-full mb-2"></div>
              <div class="h-3 bg-brand-light rounded w-5/6"></div>
            </div>
          </div>
        {%- endfor -%}
      {%- endif -%}
    </div>

    {% if section.settings.show_view_all and collection != blank and collection.all_products_count > products_to_show %}
      <div class="text-center mt-10">
        <a href="{{ collection.url }}" class="btn btn-primary">
          {{ section.settings.view_all_text | default: 'View All Products' }}
        </a>
      </div>
    {% endif %}
  </div>
</section>

<style>
  .featured-products-grid {
    display: grid;
    grid-template-columns: 1fr;
  }
  
  @media (min-width: 640px) {
    .featured-products-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  @media (min-width: 1024px) {
    .featured-products-grid {
      grid-template-columns: repeat({% if products_per_row %}{{ products_per_row | times: 1 }}{% else %}4{% endif %}, 1fr);
    }
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
</style>

{% schema %}
{
  "name": "Featured Products",
  "tag": "section",
  "class": "section-featured-products",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "default": "Featured Products",
      "label": "Heading"
    },
    {
      "type": "text",
      "id": "subtitle",
      "default": "Shop our most popular products",
      "label": "Subheading"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "select",
      "id": "background_color",
      "options": [
        {
          "value": "none",
          "label": "None"
        },
        {
          "value": "light",
          "label": "Light"
        },
        {
          "value": "dark",
          "label": "Dark"
        }
      ],
      "default": "none",
      "label": "Background color"
    },
    {
      "type": "range",
      "id": "products_per_row",
      "min": 2,
      "max": 4,
      "step": 1,
      "default": 4,
      "label": "Products per row"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 4,
      "label": "Maximum products to show"
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "default": true,
      "label": "Show description"
    },
    {
      "type": "checkbox",
      "id": "show_quick_add",
      "default": true,
      "label": "Show quick add button"
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "default": true,
      "label": "Show 'View all' button"
    },
    {
      "type": "text",
      "id": "view_all_text",
      "default": "View All Products",
      "label": "'View all' button text"
    }
  ],
  "presets": [
    {
      "name": "Featured Products",
      "settings": {
        "collection": "",
        "products_per_row": 4,
        "products_to_show": 4
      }
    }
  ]
}
{% endschema %}